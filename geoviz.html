<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
 <head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
   <title>GeoViz Demo</title>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
   <script src="figue.js" type="text/javascript"></script>
   <script src="util.js" type="text/javascript"></script>


<link rel="stylesheet" href="geoviz.css" type="text/css">

<script language="JavaScript">

var g_datasets = [ ["Choose a map", "Choose a map",0,0 , 0] ,
	["Archeology in Germany" , "kml/archaeology.kml" , new google.maps.LatLng(51.364,4.735) , 7 , "http://www.dendrochronology.eu/archaeology.kml"] ,
	["Some hotels in Firenze" , "kml/placemarks.kml" , new google.maps.LatLng(43.768118, 11.267) , 10, "http://www.es.itwg.com/citymap8/es/placemarks.kml" ] ,
	["Velib Paris" , "kml/velib.kml" ,  new google.maps.LatLng(48.8662, 2.352) , 12 , "http://www.parisavelo.net/velib.kml"] 	,
	["Nature preservation sites in the US (centered on Colorado)" , "kml/preserves.kml" ,  new google.maps.LatLng(44.27667, -90.7031, -1.2084) , 5 , "http://support.nature.org/xml/preserves.kml"] 		
	] ;

var g_map ;
var g_positions;
var g_vectors;
var g_labels;
var g_titles;
var g_tree;


function processKML(xmldoc) {
	g_tree = null ;
	g_positions = new Array() ;
	g_vectors = new Array() ;
	g_labels = new Array () ;
	g_titles = new Array () ;

     var placemarks = xmldoc.documentElement.getElementsByTagName("Placemark");
     if (placemarks.length > 0) {
       // extract the points and convert the lat/lng coordinates to map coordinates
	var lat, lng, name, coordinates, point, projcoord ;
       for (var i = 0; i < placemarks.length; i++) {
       		coordinates = placemarks.item(i).getElementsByTagName('coordinates').item(0).firstChild.nodeValue.split(","); ;
		name = placemarks.item(i).getElementsByTagName('name').item(0).firstChild.nodeValue ;
		lng = parseFloat (coordinates[0]) ; 
       		lat = parseFloat (coordinates[1]) ;
		point = new google.maps.LatLng (lat,lng) ;
		vector = new Array(2) ;
		projcoord = g_map.getProjection().fromLatLngToPoint(point) ;
		if (i==0)
			alert (projcoord);
		vector[0] = projcoord.x * 10000 ;
		vector[1] = projcoord.y * 10000 ;
		g_positions.push (point) ;
		g_vectors.push (vector) ;
		g_labels.push (i) ;
		g_titles.push(name);
       }

	// cluster the points
	g_tree = figue.agglomerate (g_labels, g_vectors , figue.EUCLIDIAN_DISTANCE,figue.SINGLE_LINKAGE) ;

	// display the tree
//	  var dendogram = g_tree.buildDendogram (5, true, true, true) ;
//	  document.getElementById('mypre').innerHTML = dendogram ;

	selectAndDisplay() ;
     }
}

function nodeSelector(node, MCD) {
	var selectedNodes ;
	if (node.isLeaf()) 
		return [node] ;
	else if (node.dist < MCD) 
		return [] ;
	else {
		selectedNodes = new Array() ;
		if (node.left != null) {
			if (node.left.isLeaf()) 
				selectedNodes.push(node.left) ;
			else {
				if (node.left.dist < MCD)
					selectedNodes.push (node.left) ;
				else
					selectedNodes = selectedNodes.concat (nodeSelector(node.left, MCD)) ;
			}
		}

		if (node.right != null) {
			if (node.right.isLeaf()) 
				selectedNodes.push(node.right) ;
			else {
				if (node.right.dist < MCD)
					selectedNodes.push (node.right) ;
				else
					selectedNodes = selectedNodes.concat (nodeSelector(node.right, MCD)) ;
			}
		}
	}

	return selectedNodes ;
}

function selectAndDisplay() {
	if (! g_tree) 
		return ;

	// determine MCD given zoomlevel
	var scale = Math.pow(2, g_map.getZoom());
	var MCD = scale * 4  ;

	// select nodes that can be displayed
	var selectedNodes = nodeSelector (g_tree , MCD) ;

	// display nodes as markers
	alert (selectedNodes.length);
	var title ; 
	var position ;
	var projcoord ;
	for (var i = 0 ; i < selectedNodes.length ; i++) {
		if (selectedNodes[i].isLeaf()) {
			title = g_titles[ selectedNodes[i].label ] ;
			position = g_positions[ selectedNodes[i].label ] ;
		} else {
			title = "Centroid" ;
			projcoord = new google.maps.Point (selectedNodes[i].centroid[0] / 10000 , selectedNodes[i].centroid[1] / 10000) ;
			position = g_map.getProjection().fromPointToLatLng(projcoord) ;
		}
		var marker = new google.maps.Marker ({
	     		position: position,
	            	map: g_map,
			title:title
    		});

	}

}

function initialize() {

	// initialize the main map
  var myOptions = {
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	        }
		g_map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);



	google.maps.event.addListener(g_map,"zoom_changed", selectAndDisplay) ;

	// create a menu containing some datasets
	var map_selector = document.getElementById('map_selector') ;
	for (var i = 0 ; i < g_datasets.length ; i++) {
  		var elOptNew = document.createElement('option');
		elOptNew.text = g_datasets[i][0];
		elOptNew.value = g_datasets[i][1] ;

	  	try {
      			map_selector.add(elOptNew, null); // standards compliant; doesn't work in IE
	        }
		catch(ex) {
		     	 map_selector.options.add(elOptNew); // IE only
  		}
	}

}


function view_original_dataset(){
	var selIndex = map_selector.selectedIndex;
	if (selIndex == 0)
		return 
	
	var dsurl = g_datasets[selIndex][4] ;
	var url = "http://www.google.com/maps?f=q&source=s_q&hl=en&geocode=&q=" + dsurl + "&vps=1&sll=-33.84447,151.228231&sspn=0.035786,0.077162&ie=UTF8"
	window.open(url);
}

function changeMap() {
	var map_selector = document.getElementById('map_selector') ;
	var selIndex = map_selector.selectedIndex;
	if (selIndex == 0)
		return 
	var url = g_datasets[selIndex][1] ;
	var center = g_datasets[selIndex][2] ;
	var zm = g_datasets[selIndex][3] ;

	downloadUrl (url , processKML) ;
//	g_map.clearOverlays();
	g_map.setCenter(center) ;
	g_map.setZoom(zm) ; 

}
</script>

</head>

<body onload="initialize()" >

<div id="map_area">
<div id="map_selection" ><select id="map_selector" onchange="changeMap()"></select></div>
<div id="map_canvas" class="map-large"></div>
<div id="original_dataset"><a href="javascript:void(0)" onclick="view_original_dataset()">View original DS</a></div>
</div>

<pre id="mypre"></pre>


<div id="footer">Â©2008 - Jean-Yves Delort</div>

</body>
</html>




